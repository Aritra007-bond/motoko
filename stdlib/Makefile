ASC=../src/asc
OUTDIR=_out
DOCDIR=doc
MDofAS=./markdown-of-actorscript.py
MDofMD=./markdown-of-markdown.py
PANDOC=pandoc

# Add new module targets here:
TESTS=\
	Option \
	Result \
	Hash \
	List \
	ListTest \
	AssocList \
	Trie \
	DocTable \
	Set \
	SetDb \
	SetDbTest \
	ProduceExchange \
	producerRemInventory \
	retailerReserveMany \
	evalBulk \


WASM=\
  ProduceExchange\
	loadWorkloadAndQueryBig\


OUTFILES=$(addsuffix .out, $(TESTS)) $(addsuffix .wasm, $(WASM))

OUTPATHS=$(addprefix $(OUTDIR)/, $(OUTFILES))

.PHONY: default all clean alltests alldoc docMd docHtml profile

default: all

docmsg:
	@echo Begin building documentation in \`$(DOCDIR)\`...
	@echo $(HRULE)

alltests: $(OUTDIR) $(OUTPATHS)

all: alltests alldoc

alldoc: docMd docHtml

# Markdown documentation, extracted from the source directory
docMd: \
	$(DOCDIR)/README.md \
	$(DOCDIR)/prelude.md \
	$(DOCDIR)/option.md \
	$(DOCDIR)/result.md \
	$(DOCDIR)/hash.md \
	$(DOCDIR)/list.md \
	$(DOCDIR)/assocList.md \
	$(DOCDIR)/trie.md \
	$(DOCDIR)/docTable.md \
	$(DOCDIR)/set.md \
	$(DOCDIR)/setDb.md \
	$(DOCDIR)/setDbTest.md \
	$(DOCDIR)/examples/produce-exchange/README.md \
	$(DOCDIR)/examples/produce-exchange/serverTypes.md \
	$(DOCDIR)/examples/produce-exchange/serverLang.md \
	$(DOCDIR)/examples/produce-exchange/serverActor.md \
	$(DOCDIR)/examples/produce-exchange/serverModelTypes.md \
	$(DOCDIR)/examples/produce-exchange/serverModel.md \
	| \
	$(DOCDIR)/ \
	$(DOCDIR)/examples/produce-exchange/

# HTML documentation, extracted from the source directory
docHtml: \
	$(DOCDIR)/README.html \
	$(DOCDIR)/prelude.html \
	$(DOCDIR)/option.html \
	$(DOCDIR)/result.html \
	$(DOCDIR)/hash.html \
	$(DOCDIR)/list.html \
	$(DOCDIR)/assocList.html \
	$(DOCDIR)/trie.html \
	$(DOCDIR)/docTable.html \
	$(DOCDIR)/set.html \
	$(DOCDIR)/setDb.html \
	$(DOCDIR)/setDbTest.html \
	$(DOCDIR)/examples/produce-exchange/README.html \
	$(DOCDIR)/examples/produce-exchange/serverTypes.html \
	$(DOCDIR)/examples/produce-exchange/serverLang.html \
	$(DOCDIR)/examples/produce-exchange/serverActor.html \
	$(DOCDIR)/examples/produce-exchange/serverModelTypes.html \
	$(DOCDIR)/examples/produce-exchange/serverModel.html \
	| \
	$(DOCDIR)/ \
	$(DOCDIR)/examples/produce-exchange/

clean:
	rm -rf $(OUTDIR) $(DOCDIR)

$(OUTDIR):
	@mkdir $@

$(DOCDIR):
	mkdir $@

$(DOCDIR)/README.md: README.md | $(DOCDIR)
	@echo "<!-- **[ DO NOT EDIT -- GENERATED by a Makefile, on `date` ]** -->" > $@
	@echo "" >> $@
	$(MDofMD) $< >> $@

$(DOCDIR)/examples/produce-exchange/: README.md
	@mkdir -p $@

$(DOCDIR)/examples/produce-exchange/README.md: examples/produce-exchange/README.md | $(DOCDIR)/examples/produce-exchange/
	@echo "<!-- **[ DO NOT EDIT -- GENERATED by a Makefile, on `date` ]** -->" > $@
	@echo "" >> $@
	$(MDofMD) $< >> $@

$(OUTDIR)/Hash.out: hash.as | $(OUTDIR)
	$(ASC) -r $(filter-out $(OUTDIR), $^) > $@

$(OUTDIR)/Option.out: option.as | $(OUTDIR)
	$(ASC) -r $(filter-out $(OUTDIR), $^) > $@

$(OUTDIR)/Result.out: result.as | $(OUTDIR)
	$(ASC) -r $(filter-out $(OUTDIR), $^) > $@

$(OUTDIR)/List.out: list.as | $(OUTDIR)
	$(ASC) -r $(filter-out $(OUTDIR), $^) > $@

$(OUTDIR)/ListTest.out: listTest.as | $(OUTDIR)
	$(ASC) -r $(filter-out $(OUTDIR), $^) > $@

$(OUTDIR)/AssocList.out: assocList.as | $(OUTDIR)
	$(ASC) -r $(filter-out $(OUTDIR), $^) > $@

$(OUTDIR)/Trie.out: trie.as | $(OUTDIR)
	$(ASC) -r $(filter-out $(OUTDIR), $^) > $@

$(OUTDIR)/DocTable.out: docTable.as | $(OUTDIR)
	$(ASC) -r $(filter-out $(OUTDIR), $^) > $@

$(OUTDIR)/Set.out: set.as | $(OUTDIR)
	$(ASC) -r $(filter-out $(OUTDIR), $^) > $@

$(OUTDIR)/SetDb.out: setDb.as | $(OUTDIR)
	$(ASC) -r $(filter-out $(OUTDIR), $^) > $@

$(OUTDIR)/SetDbTest.out: setDbTest.as | $(OUTDIR)
	$(ASC) -r $(filter-out $(OUTDIR), $^) > $@

PRODUCE_EXCHANGE_SRC=\
	prelude.as option.as hash.as list.as assocList.as trie.as docTable.as result.as \
	examples/produce-exchange/serverTypes.as \
	examples/produce-exchange/serverLang.as \
	examples/produce-exchange/serverModelTypes.as \
	examples/produce-exchange/serverModel.as \
	examples/produce-exchange/serverActor.as \

$(OUTDIR)/ProduceExchange.out: $(PRODUCE_EXCHANGE_SRC) \
	examples/produce-exchange/test/simpleSetupAndQuery.as | $(OUTDIR)
	$(ASC) -r examples/produce-exchange/serverActor.as examples/produce-exchange/test/simpleSetupAndQuery.as > $@

PROFILE_SRC=\
	examples/produce-exchange/serverActor.as \
	examples/produce-exchange/test/profileLoad.as

PROFILE_FIELDS=\
		--profile-field "hash_bit_length" \
		--profile-field "producer_count" \
		--profile-field "inventory_count" \
		--profile-field "transporter_count" \
		--profile-field "route_count" \

profile: \
	$(OUTDIR)/profileLoad.04-05-01.csv \
	$(OUTDIR)/profileLoad.04-05-05.csv \
	$(OUTDIR)/profileLoad.04-05-10.csv \
	$(OUTDIR)/profileLoad.04-05-20.csv \
	$(OUTDIR)/profileLoad.04-05-50.csv \
	$(OUTDIR)/profileLoad.04-05-100.csv \

$(OUTDIR)/profileLoad.04-05-01.csv: $(PRODUCE_EXCHANGE_SRC) $(PROFILE_SRC) | $(OUTDIR)
	$(ASC) -r --profile examples/produce-exchange/test/params-5-1.as $(PROFILE_SRC) --profile-file $@ $(PROFILE_FIELDS)

$(OUTDIR)/profileLoad.04-05-05.csv: $(PRODUCE_EXCHANGE_SRC) $(PROFILE_SRC) | $(OUTDIR)
	$(ASC) -r --profile examples/produce-exchange/test/params-5-5.as $(PROFILE_SRC) --profile-file $@ $(PROFILE_FIELDS)

$(OUTDIR)/profileLoad.04-05-10.csv: $(PRODUCE_EXCHANGE_SRC) $(PROFILE_SRC) | $(OUTDIR)
	$(ASC) -r --profile examples/produce-exchange/test/params-5-10.as $(PROFILE_SRC) --profile-file $@ $(PROFILE_FIELDS)

$(OUTDIR)/profileLoad.04-05-20.csv: $(PRODUCE_EXCHANGE_SRC) $(PROFILE_SRC) | $(OUTDIR)
	$(ASC) -r --profile examples/produce-exchange/test/params-5-20.as $(PROFILE_SRC) --profile-file $@ $(PROFILE_FIELDS)

$(OUTDIR)/profileLoad.04-05-50.csv: $(PRODUCE_EXCHANGE_SRC) $(PROFILE_SRC) | $(OUTDIR)
	$(ASC) -r --profile examples/produce-exchange/test/params-5-50.as $(PROFILE_SRC) --profile-file $@ $(PROFILE_FIELDS)

$(OUTDIR)/profileLoad.04-05-100.csv: $(PRODUCE_EXCHANGE_SRC) $(PROFILE_SRC) | $(OUTDIR)
	$(ASC) -r --profile examples/produce-exchange/test/params-5-100.as $(PROFILE_SRC) --profile-file $@ $(PROFILE_FIELDS)

$(OUTDIR)/loadWorkloadAndQueryBig.wasm: $(PRODUCE_EXCHANGE_SRC) \
	examples/produce-exchange/test/loadWorkloadAndQuery.as | $(OUTDIR)
	$(ASC) examples/produce-exchange/serverActor.as examples/produce-exchange/test/loadWorkloadAndQueryBig.as -c --dfinity -o $@

$(OUTDIR)/retailerReserveMany.out: $(PRODUCE_EXCHANGE_SRC) \
	examples/produce-exchange/test/retailerReserveMany.as | $(OUTDIR)
	$(ASC) -r examples/produce-exchange/serverActor.as examples/produce-exchange/test/retailerReserveMany.as > $@

$(OUTDIR)/producerRemInventory.out: $(PRODUCE_EXCHANGE_SRC) \
	examples/produce-exchange/test/producerRemInventory.as | $(OUTDIR)
	$(ASC) -r examples/produce-exchange/serverActor.as examples/produce-exchange/test/producerRemInventory.as > $@

$(OUTDIR)/evalBulk.out: $(PRODUCE_EXCHANGE_SRC) \
	examples/produce-exchange/test/evalBulk.as | $(OUTDIR)
	$(ASC) -r examples/produce-exchange/serverActor.as examples/produce-exchange/test/evalBulk.as > $@

$(OUTDIR)/ProduceExchange.wasm: $(PRODUCE_EXCHANGE_SRC) | $(OUTDIR)
	$(ASC) -c --dfinity -o $@ examples/produce-exchange/serverActor.as

$(DOCDIR)/%.md: %.as $(MDofAS) | $(DOCDIR)
	@echo "<!-- **[ Do not edit; This file was machine-generated on `date`. ]** -->" > $@
	@echo "" >> $@
	@echo "" >> $@
	$(MDofAS) $< >> $@

$(DOCDIR)/%.html: $(DOCDIR)/%.md
	$(PANDOC) -f gfm $^ > $@
